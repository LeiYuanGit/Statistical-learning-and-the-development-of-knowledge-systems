---
title: "Data cleaning for the raw N and More participants data"
output: rmarkdown::github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, results = "hide", message = FALSE)
```

## Overview

This code cleans the raw N and More participants data:

1. convert data from wide to long format
2. delete NA items
3. create a separate subj level accuracy column and use it to categorize children into 4 quartiles
4. adding item feature information
5. output the results into new csv files for further analysis 

It also identifies children who had completed both tasks, by concatenating their "DOB, DOE, and location" and find common values both the n and more data.

The critical output files for further analyses are: 

* Data/data_n_long.csv (long format trial-level data for N, with subject quartile and feature information)    
* Data/data_more_long.csv (long format trial-level data for More, with subject quartile and feature information)
* Data/data_within_ids.csv (the ids for children who had completed both task)
* Data/data_n_item_binomial.csv (binomial test results for each item within each quartile in the which-N task)
* Data/data_more_item_binomial.csv (binomial test results for each item within each quartile in the which-More task)

## Load libraries
```{r}
library("here")
library("tidyverse")
```

## For the N task
```{r}
# load input data
data_subj <- read.csv(here("Data", "data_n_raw_wide.csv"), check.names = FALSE)
data_item <- read.csv(here("Data", "data_n_item.csv"), check.names = FALSE)

# cleaning
data_cleaned <- data_subj %>%
  gather(key = item, value = acc, c(13:43)) %>%
  # convert from wide to long format
  mutate(
    ses = ifelse(ses == "#N/A", "NA", ses), # standardize the SES values
    sex = ifelse(is.na(sex), "NA", sex)
  ) %>%
  filter(!is.na(acc)) # delete NA items

# create quartile group column
data_quartile <- data_subj %>%
  group_by(id) %>%
  summarise(subj_acc = mean(acc)) %>%
  mutate(quartile = ntile(subj_acc, 4))

# adding quartile and item feature information to the raw data
data_cleaned <- data_cleaned %>%
  left_join(data_quartile, by = "id") %>%
  left_join(data_item, by = "item") %>%
  mutate(within_id = paste(dob, doe, sex, location)) # create a column for within subject id

# output the cleaned data
write.csv(data_cleaned, here("Data/data_n_long.csv"), row.names = FALSE)
```

## For the More task
```{r}
# load input data
data_subj <- read.csv(here("Data", "data_more_raw_wide.csv"), check.names = FALSE)
data_item <- read.csv(here("Data", "data_more_item.csv"), check.names = FALSE)

# cleaning
data_cleaned <- data_subj %>%
  gather(key = item, value = acc, c(13:92)) %>%
  # convert from wide to long format
  mutate(
    ses = ifelse(ses == "#N/A", "NA", ses), # standardize the SES values
    sex = ifelse(is.na(sex), "NA", sex)
  ) %>%
  filter(!is.na(acc)) # delete NA items

# create quartile group column
data_quartile <- data_subj %>%
  group_by(id) %>%
  summarise(subj_acc = mean(acc)) %>%
  mutate(quartile = ntile(subj_acc, 4))

# adding quartile and item feature information to the raw data
data_cleaned <- data_cleaned %>%
  left_join(data_quartile, by = "id") %>%
  left_join(data_item, by = "item") %>%
  mutate(within_id = paste(dob, doe, sex, location)) # create a column for within subject id

# output the cleaned data
write.csv(data_cleaned, here("Data/data_more_long.csv"), row.names = FALSE)
```

## Identify children who had both tasks
```{r}
data_more_long_ids <- read.csv(here("Data/data_more_long.csv"), check.names = FALSE) %>%
  distinct(within_id)

data_n_long_ids <- read.csv(here("Data/data_n_long.csv"), check.names = FALSE) %>%
  distinct(within_id) # there were twins in the which n data, but we can not decide which more task goes with which twin, so delete all 5 sets of twins.

all_within_ids <- inner_join(data_more_long_ids, data_n_long_ids, by = "within_id", all = TRUE) # find children who did both tasks

# output these ids in a csv file
write.csv(all_within_ids, here("Data/data_within_ids.csv"), row.names = F)
```

## Generate binominal test results for each items and each quartile
```{r}
# a custom function for computing binomial test results for each item and each quartile
perform_binomial_test <- function(data) {
  data %>%
    group_by(quartile, item) %>%
    # get item_acc, item_total_n, and item_total_success
    summarise(item_acc = mean(acc), item_total_n = n()) %>%
    mutate(item_total_success = item_acc * item_total_n) %>%
    # get binomial test results for each item
    rowwise() %>%
    # make sure the operation is rowwisely computed
    mutate(item_binomial_p = round(binom.test(item_total_success, item_total_n, 0.5)$p.value, 4)) %>%
    # add additional useful cols
    # significance above or below chance?
    mutate(
      sig_above = ifelse(item_binomial_p < 0.05 & item_acc > 0.5, "yes", "no"),
      sig_below = ifelse(item_binomial_p < 0.05 & item_acc < 0.5, "yes", "no")
    ) %>%
    # significance stars
    mutate(
      star_above = ifelse(sig_above == "yes", "*", " "),
      star_below = ifelse(sig_below == "yes", "*", " "),
      star = ifelse(item_binomial_p < 0.05, "*", " ")
    ) 
    # exclude items that have less than 10 participants
    # filter(item_total_n > 9)
    # exclude them later in the analysis
}

# compute item binomial test for the N and More task
data_n_long <- read.csv(here("Data/data_n_long.csv"))
data_n_item_binomial = perform_binomial_test(data_n_long)
write.csv(data_n_item_binomial, here("Data/data_n_item_binomial.csv"), row.names = FALSE)

data_more_long <- read.csv(here("Data/data_more_long.csv"))
data_more_item_binomial = perform_binomial_test(data_more_long)
write.csv(data_more_item_binomial, here("Data/data_more_item_binomial.csv"), row.names = FALSE)
```
